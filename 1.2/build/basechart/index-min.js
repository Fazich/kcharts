/*! kcharts - v1.2 - 2013-12-17 12:29:34 PM
* Copyright (c) 2013 数据可视化小组; Licensed  */
KISSY.add("gallery/kcharts/1.2/basechart/index",function(t,e){var a=t.all,r=!1,i=!1,n=function(){};return t.extend(n,e,{init:function(e){var r,i,n=this;if(e&&e.renderTo){r=n._cfg=t.mix({zIndex:0,yAxis:{spacing:{top:0,bottom:0}},xAxis:{spacing:{left:0,right:0}},canvasAttr:{x:60,y:60},defineKey:{},zoomType:"x"},e),n._$ctnNode=a(e.renderTo),n._$ctnNode.css({"-webkit-text-size-adjust":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)"}),n.createContainer(),t.mix(n,{_datas:{cur:{},total:{}},_points:{},_centerPoints:[],_pointsX:[],_pointsY:[],_gridsX:[],_gridsY:[],_areas:[],_axisX:null,_axisY:null,_labelX:[],_labelY:[],_evtEls:[],_gridPoints:[],_multiple:!1,stackable:!1});for(var o in Array.prototype)delete Array.prototype[o];if(i=r.series||null,"barchart"==n.chartType&&(r.xAxis.min=0,r.yAxis.min=0),!i||0>=i.length||!i[0].data)return;i.length>1?n._multiple=!0:void 0;for(var o in i)n._datas.total[o]={index:o,data:i[o].data},n._datas.cur[o]={index:o,data:i[o].data};n.dataFormat(),n.onResize()}},removeData:function(t){var e=this;delete e._datas.cur[t],e.dataFormat()},recoveryData:function(t){var e=this;e._datas.cur[t]=e._datas.total[t],e.dataFormat()},createContainer:function(){var t=this,e=t._$ctnNode,a=t._cfg.canvasAttr,r=a.width||e.width()-2*a.x,i=a.height||e.height()-2*a.y,n=a.x,o=a.y,s=r,c=i,l={x:n,y:o},d={x:n+r,y:o},f={x:n,y:o+c},h={x:n+r,y:o+c};t._innerContainer={x:n,y:o,width:s,height:c,tl:l,tr:d,bl:f,br:h}},getInnerContainer:function(){return this._innerContainer},getAllDatas:function(){var e,a=this,r=a._cfg,i=[],n=r.zoomType,o=arguments[0],s=a.getDataType();if(r.stackable)for(var c in a._datas.cur){"object"==s&&r.defineKey.y&&r.defineKey.x?e=a.getArrayByKey(a._datas.cur[c].data,r.defineKey.y):t.isArray(a._datas.cur[c].data)&&(e=a._datas.cur[c].data);for(var l in e)i[l]=i[l]?e[l]-0+(i[l]-0):e[l]}else for(var c in a._datas.cur)"object"==s&&r.defineKey.y&&r.defineKey.x?e=a.getArrayByKey(a._datas.cur[c].data,r.defineKey.y):t.isArray(a._datas.cur[c].data)&&(e="xy"==n?a.getArrayByKey(a._datas.cur[c].data,o):a._datas.cur[c].data),i.push(e.join(","));return i.length?i.join(",").split(","):[]},getDataType:function(){var e=this;if(e._datas.total[0]&&e._datas.total[0].data)for(var a in e._datas.total[0].data){if(t.isPlainObject(e._datas.total[0].data[a]))return"object";if(t.isNumber(e._datas.total[0].data[a]-0))return"number"}},_getScales:function(e,a){var n=this;if(a.text&&t.isArray(a.text))return a.text;var o=a.max/1,s=a.min/1,c=a.num||5,l=Math.max.apply(null,e),d=Math.min.apply(null,e);r=0>=l?1:0,i=d>=0?1:0;var f=.1*(l-d),h=o||0==o?o>=l?o:l+f:l+f,p=s||0==s?d>=s?s:d-f:d-f;return n.getScales(h,p,c)},dataFormat:function(){var e,a,r,i,n,o,s,c=this,l=c._cfg,d=l.zoomType,f=c._innerContainer,h=l.xAxis.spacing?c.px2num(l.xAxis.spacing.left):0,p=l.xAxis.spacing?c.px2num(l.xAxis.spacing.right):0,u=l.yAxis.spacing?c.px2num(l.yAxis.spacing.top):0,x=l.yAxis.spacing?c.px2num(l.yAxis.spacing.bottom):0,_=f.width-h-p,g=f.height-u-x,y=f.x/1+h,b=f.y/1+u;c._pointsY=[],c._pointsX=[],"x"==d?(e=c.getAllDatas(),s=r=c.coordNum=c._getScales(e,l.yAxis),n=c.data2GrapicData(r,!1,!0)):"y"==d?(a=c.getAllDatas(),s=i=c.coordNumX=c._getScales(a,l.xAxis),o=c.data2GrapicData(i,!0,!1)):"xy"==d&&(e=c.getAllDatas(0),a=c.getAllDatas(1),s=r=c.coordNum=c._getScales(e,l.xAxis),i=c.coordNumX=c._getScales(a,l.yAxis),n=c.data2GrapicData(r,!1,!1),o=c.data2GrapicData(i,!0,!0));var v=function(e,a,r){var i=l.series[a],n=Math.max.apply(null,r),o=Math.min.apply(null,r),s=l.defineKey,f=s.x,h=s.y,p=[],u=0,x=c.getDataType();if("x"==d)if(f&&h&&"object"==x)for(var v in c._pointsX)e[u]&&l.xAxis.text[v]==e[u][f]?(p[v]={x:c._pointsX[v].x,y:c.data2Grapic(e[u][h],n,o,g,b,!0),dataInfo:e[u],index:Math.round(v)},u++):p[v]={x:c._pointsX[v].x,index:Math.round(v)};else for(var v in c._pointsX)p[v]=""===e[v]||null===e[v]?{x:c._pointsX[v].x,index:Math.round(v)}:{x:c._pointsX[v].x,y:c.data2Grapic(e[v],n,o,g,b,!0),dataInfo:{y:e[v],x:l.xAxis.text[v]},index:Math.round(v)};else if("y"==d)if(f&&h&&t.isPlainObject(c._datas.total[0].data[0]))for(var v in c._pointsY)e[u]&&l.yAxis.text[v]==e[u][f]?(p[v]={x:c.data2Grapic(e[u][h],n,o,_,y),y:c._pointsY[v].y,dataInfo:{y:e[u]},index:Math.round(v)},u++):p[v]={y:c._pointsY[v].y,index:Math.round(v)};else for(var v in c._pointsY)p[v]={x:c.data2Grapic(e[v],n,o,_,y),y:c._pointsY[v].y,dataInfo:{y:e[v],x:l.yAxis.text[v]},index:Math.round(v)};else if("xy"==d){var m=c.data2GrapicData(c.getArrayByKey(i.data,0)),w=c.data2GrapicData(c.getArrayByKey(i.data,1),!0,!0);for(var v in i.data)p[v]={x:m[v],y:w[v],dataInfo:{y:e[v]},index:Math.round(v)}}return p};if("x"==d){for(var m in n)c._pointsY[m]={number:r[m]+"",y:n[m],x:y};try{c._gridPoints=c.getSplitPoints(y,b+g,y+_,b+g,l.xAxis.text.length,!0),c._pointsX=c.getCenterPoints(c._gridPoints)}catch(w){throw Error("未配置正确的xAxis.text数组")}}else if("y"==d){for(var m in o)c._pointsX[m]={number:i[m]+"",y:b+g,x:o[m]};try{c._pointsY=c.getSplitPoints(y,b,y,b+g,l.yAxis.text.length+1)}catch(w){throw Error("未配置正确的yAxis.text数组")}}else if("xy"==d){for(var m in o)c._pointsY[m]={number:i[m]+"",y:o[m],x:y};for(var m in n)c._pointsX[m]={number:r[m]+"",y:b+g,x:n[m]}}for(var m in c._datas.cur)c._points[m]=v(c._datas.cur[m].data,m,s)},data2GrapicData:function(e,a,r){if(void 0!==e){var i,n=this,o=n._innerContainer,s=a?o.x:o.y,c=o.height,l=o.width,d=n._cfg.zoomType,f=a?Math.max.apply(null,n.coordNumX):Math.max.apply(null,n.coordNum),h=a?Math.min.apply(null,n.coordNumX):Math.min.apply(null,n.coordNum),p=[];if("xy"==d?i=a?c:l:"x"==d?i=c:"y"==d&&(i=l),t.isArray(e)){for(var u in e)p.push(n.data2Grapic(e[u],f,h,i,s,r));return p}return n.data2Grapic(e,f,h,i,s,r)}},data2Grapic:function(t,e,a,r,i,n){return 0>=e-a?void 0:n?r*(1-(t-a)/(e-a))+i:r*(t-a)/(e-a)+i},getSplitPoints:function(t,e,a,r,i,n){var o=(a-t)/i,s=(r-e)/i,c=[];n&&c.push({x:t,y:e});for(var l=0;i-1>l;l++)c.push({x:t+(l+1)*o,y:e+(l+1)*s});return n&&c.push({x:a,y:r}),c},getCenterPoints:function(t){var e=[],a=t.length;if(a>1)for(var r=0;a-1>r;r++)e[r]={x:(t[r].x+t[r+1].x)/2,y:(t[r].y+t[r+1].y)/2};return e},getScales:function(t,e,a){var n,o,s,c,l,d,f,h=this,p=Math.log,u=Math.pow,x=[],_=0;if(!(e>=t)){for(n=(t-e)/a,s=Math.floor(p(n)/p(10))+1,o=n/u(10,s),o=o>0&&.1>=o?.1:o>.1&&.2>=o?.2:o>.2&&.25>=o?.25:o>.25&&.5>=o?.5:1,c=o*u(10,s),f=(t+e)/2-(t+e)/2%c,l=d=f;l>e;)l-=c;for(;t>d;)d+=c;if(h.isFloat(c)){var g=c+"";g.indexOf(".")>-1&&(_=g.split(".")[1].length>4?4:g.split(".")[1].length)}for(var y=l;d>=y;y+=c)x.push(parseFloat(y).toFixed(_));if(r)for(y in x)x[y]>0&&x.splice(y,1);else if(i)for(y in x)0>x[y]&&x.splice(y,1);return x}},arraySort:function(t,e,a){return t.sort(function(t,r){return e?"object"==typeof t&&"object"==typeof r?r[a]-t[a]:r-t:"object"==typeof t&&"object"==typeof r?t[a]-r[a]:t-r})},getArrayByKey:function(e,a){var r=[];for(var i in e)(e[i][a]||t.isNumber(e[i][a]))&&r.push(e[i][a]);return r},isFloat:function(t){return/^([+-]?)\d*\.\d+$/.test(t)},obj2Array:function(t,e){var a=[];for(var r in t)a.push(e?t[e]:t[r]);return a},getObjKeys:function(t){var e=[];for(b in t)e.push(b);return e},isInSide:function(t,e,a,r,i,n){return t>a&&a- -i>t&&e>r&&r- -n>e?!0:!1},px2num:function(t){var t=t||0;return Math.round((t+"").replace(/\s+|px/g,"")),Math.round((t+"").replace(/\s+|px/g,""))},getOffset:function(e){var a=e.currentTarget;if(e.offsetX)return{offsetX:e.offsetX,offsetY:e.offsetY};var r=t.DOM.offset(a);return{offsetX:e.offsetX||e.pageX-r.left,offsetY:e.offsetY||e.pageY-r.top}},onResize:function(){var t=this,e=t._$ctnNode,r=e.width(),i=e.height();!t.__isResizeBind&&a(window).on("resize",function(){t.__isResizeBind=1,(e.width()!=r||e.height()!=i)&&(r=e.width(),i=e.height(),t.fire("resize"))})}}),n},{requires:["base","node"]});